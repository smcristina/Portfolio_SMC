<!-- pnl.component.html -->
<div>
  <div class="modal">
    <div class="container">
      <div class="pnl-container">
        <h3>Inserisci Dati PNL</h3>

        <div class="btns-container">
          <button (click)="showPNLWithoutBackfill()" [class.selected]="!hasBackfill">
            PNL senza Backfill <i class="material-icons">person</i>
          </button>
          <button (click)="showPNLWithBackfill()" [class.selected]="hasBackfill">
            PNL con Backfill <i class="material-icons">people_alt</i>
          </button>
        </div>

        <!-- SIMPLE (no backfill) -->
        <div *ngIf="!hasBackfill" class="backfill-form">
          <div class="rows">
            <div style="width: 20%;">
              <label>Giornate totali</label>
              <input type="number" [(ngModel)]="pnl.quantity_days" (ngModelChange)="calculateTotalPriceAndMargin()"
                name="quantity_days" placeholder="Giorni annui" />
            </div>

            <div style="width: 75%;">
              <label>Risorsa</label>
              <select [(ngModel)]="pnl.resource" (ngModelChange)="onEmployeeSelect($event)" name="resource">
                <option hidden value="" disabled selected>Scegli dipendente</option>
                <option *ngFor="let emp of employees" [value]="emp.id">
                  {{ emp.first_name }} {{ emp.last_name }}
                </option>
              </select>
            </div>
          </div>

          <div class="rows">
            <div style="width: 35%;">
              <label>Tipo di lavoro</label>
              <select [(ngModel)]="pnl.work_mode" name="work_mode">
                <option hidden value="" disabled selected>Scegli</option>
                <option *ngFor="let mode of workModes" [value]="mode.value">{{ mode.label }}</option>
              </select>
            </div>

            <div style="width: 18%;">
              <label>Costo unitario (€)</label>
              <input type="number" step="0.01" [(ngModel)]="pnl.unit_cost" (ngModelChange)="calculateTotalCost()"
                name="unit_cost" placeholder="Costo della risorsa" />
            </div>

            <div style="width: 18%;">
              <label>Costo totale (€)</label>
              <input type="number" step="0.01" [value]="pnl.total_cost" [class.flash]="flashTotalCost" readonly
                placeholder="Costo totale risorsa" />
            </div>

            <div style="width: 18%;">
              <label>Costo totale servizio (€)</label>
              <input type="number" step="0.01" [value]="pnl.total_service_cost" readonly name="total_service_cost"
                placeholder="Costo totale servizio" />
            </div>
          </div>

          <div class="rows" style="margin-bottom: 40px !important;">
            <div style="width: 18%;">
              <label>Markup</label>
              <input type="number" [(ngModel)]="pnl.markup" name="markup" (ngModelChange)="onMarkupChange()" />
            </div>
            <div style="width: 18%;">
              <label>Prezzo unitario (€)</label>
              <input type="number" step="0.01" [(ngModel)]="pnl.unit_price" (ngModelChange)="onUnitPriceChange()"
                name="unit_price" placeholder="Prezzo unitario" />
            </div>

            <div style="width: 18%;">
              <label>Prezzo totale (€)</label>
              <input type="number" step="0.01" [value]="pnl.total_price" [class.flash]="flashTotalPrice" readonly
                placeholder="Prezzo totale" />
            </div>

            <div style="width: 18%;">
              <label>% Margine</label>
              <input type="number" step="0.01" [value]="pnl.margin_percentage" readonly placeholder="% Margine" />
            </div>

            <div style="width: 18%;">
              <label>Margine lordo totale</label>
              <input type="number" step="0.01" [value]="pnl.total_gross_margin" readonly />
            </div>
          </div>

          <div class="extra-container">
            <div>
              <label for="company-name">Extra</label>
              <select (change)="onToolChange($event)" [(ngModel)]="selectedTool" class="form-control" required
                aria-placeholder="tool">
                <option value="" disabled selected hidden>Scegli tools</option>
                <option *ngFor="let tool of tools" [value]="tool.id">{{ tool.tool }}</option>
              </select>
            </div>
            <div style="display:flex; justify-content:flex-start; align-items:center;">
              Costo totale:
              <span
                style="background-color: #fab7169e; color: #292929; padding: 5px; border-radius: 3px; margin-left: 10px;">
                {{pnl.total_service_cost | currency: 'EUR'}}
              </span>
            </div>
          </div>
        </div>

        <!-- BACKFILL (multiple resources) -->
        <div *ngIf="hasBackfill" style="width: 95%;">
          <div class="backfill-form">
            <div class="backfill-rows">
              <div class="rows" style="margin-bottom: 10px !important;"
                *ngFor="let res of pnl.resources; let i = index">
                <div style="width: 15%;">
                  <label>Giornate totali</label>
                  <input type="number" [(ngModel)]="res.quantity_days" (ngModelChange)="calculateResourceTotals(i)"
                    [name]="'quantity_days_' + i" placeholder="Giorni annui" />
                </div>
                <div
                  style="width: 50%; display: flex; flex-direction: row; justify-content: space-evenly; align-items: center;">
                  <div style="width: 100%; display: flex; flex-direction: column;">
                    <label style="text-align: left;">Risorsa</label>
                    <select [(ngModel)]="res.resource" (ngModelChange)="onEmployeeSelect($event, i)"
                      [name]="'resource_' + i">
                      <option hidden value="" disabled selected>Scegli dipendente</option>
                      <option *ngFor="let emp of employees" [value]="emp.id">{{ emp.first_name }} {{ emp.last_name }}
                      </option>
                    </select>
                  </div>
                  <div class="action-btn-container">
                    <label for="">Add</label>
                    <button type="button" (click)="addResource()">
                      <img src="../../../../../assets/icons/plus.png" alt="+" width="25px">
                    </button>
                  </div>
                  <div class="action-btn-container">
                    <label for="">Delete</label>
                    <button type="button" (click)="removeResource(i)">
                      <i class="material-icons" style="color: #cc112a;">delete</i>
                    </button>
                  </div>
                </div>

                <div style="width: 12%; margin-left: 10px;">
                  <label>Costo (€)</label>
                  <input type="number" step="0.01" [(ngModel)]="res.unit_cost"
                    (ngModelChange)="calculateResourceTotals(i)" [name]="'unit_cost_' + i"
                    placeholder="Costo unitario" />
                </div>

                <div style="width: 12%; margin-left: 10px;">
                  <label>Costo totale (€)</label>
                  <input type="number" step="0.01" [value]="res.total_cost" readonly
                    placeholder="Costo totale risorsa" />
                </div>

              </div>
            </div>

            <div class="rows" style="margin-top: 10px;">
              <div style="width: 28%;">
                <label>Tipo di lavoro</label>
                <select [(ngModel)]="pnl.work_mode" name="work_mode">
                  <option hidden value="" disabled selected>Scegli</option>
                  <option *ngFor="let mode of workModes" [value]="mode.value">{{ mode.label }}</option>
                </select>
              </div>



              <div style="width: 20%;">
                <label>Costo totale (€)</label>
                <input type="number" step="0.01" [value]="pnl.total_cost" [class.flash]="flashTotalCost" readonly />
              </div>

              <div style="width: 20%;">
                <label>Costo totale servizio</label>
                <input type="number" step="0.01" [value]="pnl.total_service_cost" readonly name="total_service_cost" />
              </div>
              <div style="width: 20%;">
                <label>Markup</label>
                <input type="number" [(ngModel)]="pnl.markup" name="markup" (ngModelChange)="onMarkupChange()" />
              </div>
            </div>

            <div class="rows" style="margin-bottom: 40px !important;">
              <div style="width: 22%;">
                <label>Prezzo unitario</label>
                <input type="number" step="0.01" [(ngModel)]="pnl.unit_price" (ngModelChange)="onUnitPriceChange()"
                  name="unit_price" placeholder="Prezzo unitario" />
              </div>

              <div style="width: 22%;">
                <label>Prezzo totale (€)</label>
                <input type="number" step="0.01" [value]="pnl.total_price" [class.flash]="flashTotalPrice" readonly />
              </div>
              <div style="width: 22%;">
                <label>% Margine</label>
                <input type="number" step="0.01" [value]="pnl.margin_percentage" readonly />
              </div>

              <div style="width: 22%;">
                <label>Margine lordo totale</label>
                <input type="number" step="0.01" [value]="pnl.total_gross_margin" readonly />
              </div>
            </div>

            <div class="extra-container">
              <div>
                <label for="company-name">Extra</label>
                <select (change)="onToolChange($event)" [(ngModel)]="selectedTool" class="form-control" required>
                  <option value="" disabled selected hidden>Scegli tools</option>
                  <option *ngFor="let tool of tools" [value]="tool.id">{{ tool.tool }}</option>
                </select>
              </div>
              <div style="display:flex; justify-content:flex-end; align-items:center;">
                Costo totale:
                <span
                  style="background-color: #fab7169e; color: #292929; padding: 5px; border-radius: 3px; margin-left: 10px;">
                  {{pnl.total_service_cost | currency: 'EUR'}}
                </span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="confirm-bttns-container">
    <button (click)="goBack()" class="all-action-buttons">Cancella</button>
    <button (click)="savePNL()" class="all-action-buttons">Salva</button>
  </div>
</div>